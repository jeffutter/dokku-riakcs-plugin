#!/bin/bash
set -e;

# Check if name is specified
if [[ $1 == riakcs:* ]]; then
    if [[ -z $2 ]]; then
        echo "You must specify an app name"
        exit 1
    else
        APP="$2"
        # Check if app exists with the same name
        if [[ -d "/home/git/$APP" ]]; then
            APP_EXISTS=true
        else
            APP_EXISTS=false
        fi
    fi
fi

if [[ $APP_EXISTS == false ]]; then
  echo "App must exist before creating RiakCS storage for it"
  exit 1
fi

ADMIN_KEY=`cat /home/git/.riakcs/admin_user.json | grep -E -o '"key_id":"[^\"]+"' | sed -e 's/\"//g' | cut -d : -f 2`
ADMIN_SECRET=`cat /home/git/.riakcs/admin_user.json | grep -E -o '"key_secret":"[^\"]+"' | sed -e 's/\"//g' | cut -d : -f 2`
USER_KEY=`cat /home/git/.riakcs/user_$APP.json | grep -E -o '"key_id":"[^\"]+"' | sed -e 's/\"//g' | cut -d : -f 2`
USER_SECRET=`cat /home/git/.riakcs/user_$APP.json | grep -E -o '"key_secret":"[^\"]+"' | sed -e 's/\"//g' | cut -d : -f 2`
RIAK_CONTAINER=`docker ps|grep "jeffutter/riakcs:latest"| cut -f 1 -d ' '`
RIAK_PORT=`docker port ${RIAK_CONTAINER} 8080`

case "$1" in
  riakcs:create)
    perl /home/git/.riakcs/s3-curl/s3curl.pl --id "${ADMIN_KEY}" --key "${ADMIN_SECRET}" --contentType application/json --post -- -s -x localhost:${RIAK_PORT} --data "{\"email\":\"${APP}@${HOSTNAME}\", \"name\":\"${APP}\"}" http://riak-cs.s3.amazonaws.com/user > /home/git/.riakcs/user_$APP.json
    USER_KEY=`cat /home/git/.riakcs/user_$APP.json | grep -E -o '"key_id":"[^\"]+"' | sed -e 's/\"//g' | cut -d : -f 2`
    USER_SECRET=`cat /home/git/.riakcs/user_$APP.json | grep -E -o '"key_secret":"[^\"]+"' | sed -e 's/\"//g' | cut -d : -f 2`
    if [[ ! -f /home/git/$APP/ENV ]]; then
      touch /home/git/$APP/ENV
    fi
    awk '/^S3_PORT=/ {print "S3_PORT='$RIAK_PORT'"; found=1} !/^S3_PORT=/ {print $0} END {if (!found) {print "S3_PORT='$RIAK_PORT'" }}' /home/git/$APP/ENV > /home/git/$APP/ENV.new
    mv /home/git/$APP/ENV.new /home/git/$APP/ENV
    awk '/^S3_KEY=/ {print "S3_KEY='$USER_KEY'"; found=1} !/^S3_KEY=/ {print $0} END {if (!found) {print "S3_KEY='$USER_KEY'" }}' /home/git/$APP/ENV > /home/git/$APP/ENV.new
    mv /home/git/$APP/ENV.new /home/git/$APP/ENV
    awk '/^S3_SECRET=/ {print "S3_SECRET='$USER_SECRET'"; found=1} !/^S3_SECRET=/ {print $0} END {if (!found) {print "S3_SECRET='$USER_SECRET'" }}' /home/git/$APP/ENV > /home/git/$APP/ENV.new
    mv /home/git/$APP/ENV.new /home/git/$APP/ENV
    chown git: /home/git/$APP/ENV
    ;;
  riakcs:delete)
    perl /home/git/.riakcs/s3-curl/s3curl.pl --id "${ADMIN_KEY}" --key "${ADMIN_SECRET}" --delete -- -s -x localhost:${RIAK_PORT} http://riak-cs.s3.amazonaws.com/user/${USER_KEY}
    if [[ ! -f /home/git/$APP/ENV ]]; then
      touch /home/git/$APP/ENV
    fi
    cat /home/git/$APP/ENV | grep -V 'S3_KEY' | grep -V 'S3_SECRET' | grep -V 'S3_PORT' > /home/git/$APP/ENV.new
    mv /home/git/$APP/ENV.new /home/git/$APP/ENV
    chown git: /home/git/$APP/ENV
    ;;
  riakcs:list)
    perl /home/git/.riakcs/s3-curl/s3curl.pl --id "${ADMIN_KEY}" --key "${ADMIN_SECRET}" -- -s -x localhost:${RIAK_PORT} -H "Accept: application/json" http://s3.amazonaws.com/riak-cs/users
    ;;
esac
cat
